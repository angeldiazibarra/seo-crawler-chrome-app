!function(){"use strict";var app=angular.module("myCrawler",[]);app.factory("urlData",function($http,$q){return{getData:function(url){var deferred=$q.defer();return $http.get(url).success(function(data){deferred.resolve(data)}).error(function(data,status){deferred.reject(status)}),deferred.promise}}}),app.directive("showTab",function(){return{link:function(scope,element){element.click(function(e){if(e.preventDefault(),!element.parent().hasClass("disabled")){$(element).tab("show"),tab=element.parent().attr("id");var tabid="#"+tab+"tab";$(".navtabs").hide(),$(tabid).show()}})}}}),app.controller("CrawlerController",function($scope,urlData){this.website=web,this.navtab=tab,$scope.CheckUrl=function(){var checkUrl=web.hostname;checkUrl.match(/^(http:\/\/)/i)&&(web.protocol="http://",checkUrl=checkUrl.replace(/^(http:\/\/)/i,"")),checkUrl.match(/^(https:\/\/)/i)&&(web.protocol="https://",checkUrl=checkUrl.replace(/^(https:\/\/)/i,"")),web.hostname=checkUrl,web.invalidurl=checkUrl.match(/^(https?:\/\/)?([a-z0-9]+\.*-*)+(\.[a-z]{2,6})$/i)?!1:!0},$scope.SelectProtocol=function(protocol){web.protocol=protocol},$scope.ShowRobots=function(){return null===web.robotsurl?"false":"true"},$scope.ShowSitemaps=function(){return web.sitemaps=$scope.ArrayUnique(web.sitemaps),0===web.sitemaps.length?"false":"true"},$scope.ShowPages=function(){return web.pages=$scope.ArrayUnique(web.pages),0===web.pages.length?"false":"true"},$scope.ShowImages=function(){return 0===web.images.length?"false":"true"},$scope.ShowLinks=function(){return 0===web.internal.length&&0===web.external.length?"false":"true"},$scope.ShowExternal=function(){return 0===web.external.length?"false":"true"},$scope.ShowInternal=function(){return 0===web.internal.length?"false":"true"},$scope.ArrayUnique=function(a){return a.reduce(function(p,c){return p.indexOf(c)<0&&p.push(c),p},[])},$scope.CodeComment=function(line){return line.indexOf("#")>-1?"codecomment":void 0},$scope.parseRobots=function(data){var robotsArray=data.match(/[^\r\n]+/g);web.robotstxt=robotsArray;for(var i in robotsArray)if(robotsArray[i].match(/sitemap:/i)){var sitemap=robotsArray[i].replace(/sitemap\:/i,"").trim();-1===web.sitemaps.indexOf(sitemap)&&web.sitemaps.push(sitemap)}},$scope.crawlSitemaps=function(){for(var i in web.sitemaps)urlData.getData(web.sitemaps[i]).then(function(data){$scope.parseSitemap(data);for(var j in web.sitemaps)urlData.getData(web.sitemaps[j]).then(function(data){$scope.parseSitemap(data)})})},$scope.parseSitemap=function(data){var urlsArray1=data.match(/(\<loc\>)([a-z0-9:\/\-\.\?\=\#\_])*(\<\/loc\>)/gi),urlsArray2=data.match(/(\<link\>)([a-z0-9:\/\-\.\?\=\#\_])*(\<\/link\>)/gi);for(var i in urlsArray1){var item=urlsArray1[i].trim(),unit=item.replace(/\<\/?loc\>/gi,"").trim();unit.match(/(\.xml)$/i)?(web.sitemaps.push(unit),-1===web.sitemaps.indexOf(unit)&&web.sitemaps.push(unit)):-1===web.urls.indexOf(unit)&&(web.urls.push(unit),web.mapurls.push(unit))}for(var i in urlsArray2){var item=urlsArray2[i].trim(),unit=item.replace(/\<\/?link\>/gi,"").trim();-1===web.urls.indexOf(unit)&&(web.urls.push(unit),web.mapurls.push(unit))}},$scope.TrimString=function(string,length){var trimmedString=string.length>length?string.substring(0,length-3)+"...":string.substring(0,length);return trimmedString},$scope.DoCrawl=function(){web.urls=[],web.sitemaps=[],web.processed=[],web.pages=[],web.robotstxt=null;var url=web.protocol+web.hostname,robotsUrl=web.protocol+web.hostname+"/robots.txt",sitemapUrl=web.protocol+web.hostname+"/sitemap.xml";web.robotsurl=robotsUrl,web.sitemaps.push(sitemapUrl),web.urls.push(url),$scope.crawlSitemaps(),urlData.getData(robotsUrl).then(function(data){$scope.parseRobots(data),$scope.crawlSitemaps()}).then(function(){})},$scope.IsInArray=function(value,array){return array.indexOf(value)>-1},$scope.$watch("web",function(){},!0),setInterval(function(){web.urls=$scope.ArrayUnique(web.urls),0!==web.urls.length&&web.processed.length<=10&&web.urls.forEach(function(url){if(!$scope.IsInArray(url,web.processed)){web.processed.push(url);var crawlurl="http://www.metricspot.com/api/crawlurl?url="+url;urlData.getData(crawlurl).then(function(data){web.processed.push(data.url),data.displayurl=data.url.replace(/^http:\/\//i,""),data.displaytitle=$scope.TrimString(data.title,70),data.displaydescription=$scope.TrimString(data.metadescription,155),0===data.title.length||data.title===!1?(data.title=!1,data.titlemessage="ERROR - Not set",data.tscore="error"):data.title.length>70?(data.titlemessage="ERROR - Too long",data.tscore="error"):(data.titlemessage=!1,data.tscore="pass"),0===data.metadescription.length||data.metadescription===!1?(data.metadescription=!1,data.descriptionmessage="ERROR - Not set",data.dscore="error"):data.metadescription.length>155?(data.descriptionmessage="ERROR - Too long",data.dscore="error"):data.metadescription.length<70?(data.descriptionmessage="ERROR - Too short",data.dscore="error"):data.metadescription.length>145&&data.metadescription.length<156?(data.descriptionmessage="WARNING - Possibly cut",data.dscore="warning"):(data.descriptionmessage=!1,data.dscore="pass"),data.url===data.canonical&&data.canonical!==!1?(data.canonicalmessage=!1,data.cscore="pass"):data.url!==data.canonical&&data.canonical!==!1?(data.canonicalmessage="ERROR - URL and canonical do not match",data.cscore="error"):(data.canonicalmessage="ERROR - Canonical not set",data.cscore="error"),data.author!==!1?(data.authormessage=!1,data.ascore="pass"):(data.authormessage="WARNING - Google+ authorship not set",data.ascore="warning"),data.publisher!==!1?(data.publishermessage=!1,data.pscore="pass"):(data.publishermessage="WARNING - Google+ publisher not set",data.pscore="warning"),data.dcscore=1===data.descriptioncount?"pass":"error",data.escore=data.encoding===!1?"error":"pass",data.lscore=data.language===!1?"error":"pass",data.hscore=data.headers.h1.length?"pass":"error",data.links.internal.forEach(function(link){link.url=data.url,web.internal.push(link),$scope.IsInArray(link.url,web.processed)||$scope.IsInArray(link.url,web.urls)||web.urls.push(link.url)}),data.links.external.forEach(function(link){link.url=data.url,web.external.push(link)});var imgarray=$.map(data.images,function(value){return[value]});imgarray.forEach(function(img){delete img.anchornum,img.url=data.url,web.images.push(img)}),web.pages.push(data)})}})},1e3)});var tab="home",web={hostname:null,protocol:"http://",invalidurl:!0,robotsurl:null,robotstxt:null,sitemaps:[],urls:[],mapurls:[],processed:[],pages:[],external:[],internal:[],images:[]}}();